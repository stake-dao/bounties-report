name: "sdTokens: Generate Merkles"

on:
  workflow_dispatch:
    inputs:
      token:
        description: 'Which token merkle to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - spectra
          - sdfxs
      publish:
        description: 'Publish merkles to latest after generation'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  repository_dispatch:
    types:
      - generate-spectra-merkle
      - generate-sdfxs-merkle
      - generate-all-sd-merkles
      - copy-sdtkns-merkle
      - copy-spectra-merkle
      - copy-sdfxs-merkle
      - copy-all-sd-merkles

jobs:
  generate-spectra-merkle:
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.token == 'all' || 
      github.event.inputs.token == 'spectra' || 
      github.event.action == 'generate-spectra-merkle' ||
      github.event.action == 'generate-all-sd-merkles'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Configure git and pull latest changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git pull origin main --rebase

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10.13"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.5.1"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run Spectra merkle generation
        run: make -f automation/spectra/run.mk run-all
        env:
          EXPLORER_KEY: ${{ secrets.ETHERSCAN_TOKEN }}
          WEB3_ALCHEMY_API_KEY: ${{ secrets.WEB3_ALCHEMY_API_KEY}}

      - name: Rebase on latest main before auto-commit
        run: git pull --rebase --autostash origin main

      - uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "chore: Update Spectra merkles"
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>

      - name: Clean up
        if: always()
        run: make -f automation/spectra/run.mk clean

      - name: Send error notification to Telegram
        if: failure()
        uses: appleboy/telegram-action@v1.0.1
        with:
          to: -1002354704686
          token: ${{ secrets.TG_API_KEY_BOT_ERROR }}
          format: html
          message: |
            ‚ùå <b>Workflow failed</b>
            ‚Ä¢ <b>Workflow:</b> ${{ github.workflow }}
            ‚Ä¢ <b>Job:</b> generate-spectra-merkle
            ‚Ä¢ <b>Token:</b> Spectra
            ‚Ä¢ <b>Trigger:</b> ${{ github.event_name }}
            ‚Ä¢ <b>Status:</b> ${{ job.status }}
            üìã <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View workflow logs</a>

  generate-sdfxs-merkle:
    runs-on: ubuntu-latest
    needs: generate-spectra-merkle
    if: |
      always() && 
      (needs.generate-spectra-merkle.result == 'success' || needs.generate-spectra-merkle.result == 'skipped') &&
      (github.event.inputs.token == 'all' || 
       github.event.inputs.token == 'sdfxs' || 
       github.event.action == 'generate-sdfxs-merkle' ||
       github.event.action == 'generate-all-sd-merkles')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Configure git and pull latest changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git pull origin main --rebase

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10.13"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.5.1"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run sdFXS merkle generation
        run: make -f automation/sdfxs/run.mk run-merkle
        env:
          EXPLORER_KEY: ${{ secrets.ETHERSCAN_TOKEN }}
          WEB3_ALCHEMY_API_KEY: ${{ secrets.WEB3_ALCHEMY_API_KEY}}

      - name: Rebase on latest main before auto-commit
        run: git pull --rebase --autostash origin main

      - uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "chore: Update sdFXS merkles"
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>

      - name: Clean up
        if: always()
        run: make -f automation/sdfxs/run.mk clean

      - name: Send error notification to Telegram
        if: failure()
        uses: appleboy/telegram-action@v1.0.1
        with:
          to: -1002354704686
          token: ${{ secrets.TG_API_KEY_BOT_ERROR }}
          format: html
          message: |
            ‚ùå <b>Workflow failed</b>
            ‚Ä¢ <b>Workflow:</b> ${{ github.workflow }}
            ‚Ä¢ <b>Job:</b> generate-sdfxs-merkle
            ‚Ä¢ <b>Token:</b> sdFXS
            ‚Ä¢ <b>Trigger:</b> ${{ github.event_name }}
            ‚Ä¢ <b>Status:</b> ${{ job.status }}
            üìã <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View workflow logs</a>

  # ===== Publish Merkles to Latest =====
  publish-merkles:
    runs-on: ubuntu-latest
    needs: [generate-spectra-merkle, generate-sdfxs-merkle]
    if: |
      always() &&
      (needs.generate-spectra-merkle.result == 'success' || needs.generate-spectra-merkle.result == 'skipped') &&
      (needs.generate-sdfxs-merkle.result == 'success' || needs.generate-sdfxs-merkle.result == 'skipped') &&
      (
        github.event.inputs.publish != 'false' ||
        github.event.action == 'copy-sdtkns-merkle' ||
        github.event.action == 'copy-spectra-merkle' ||
        github.event.action == 'copy-sdfxs-merkle' ||
        github.event.action == 'copy-all-sd-merkles'
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Configure git and pull latest changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git pull origin main --rebase

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.5.1"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Determine publish type
        id: determine-type
        run: |
          # Determine what to publish based on trigger
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            case "${{ github.event.action }}" in
              "copy-sdtkns-merkle")
                echo "type=sdtkns" >> $GITHUB_OUTPUT
                ;;
              "copy-spectra-merkle")
                echo "type=sdtkns-universal" >> $GITHUB_OUTPUT
                echo "copy_spectra=true" >> $GITHUB_OUTPUT
                echo "copy_sdfxs=false" >> $GITHUB_OUTPUT
                ;;
              "copy-sdfxs-merkle")
                echo "type=sdtkns-universal" >> $GITHUB_OUTPUT
                echo "copy_spectra=false" >> $GITHUB_OUTPUT
                echo "copy_sdfxs=true" >> $GITHUB_OUTPUT
                ;;
              "copy-all-sd-merkles"|"generate-all-sd-merkles")
                echo "type=sdtkns-universal" >> $GITHUB_OUTPUT
                echo "copy_spectra=true" >> $GITHUB_OUTPUT
                echo "copy_sdfxs=true" >> $GITHUB_OUTPUT
                ;;
              "generate-spectra-merkle")
                echo "type=sdtkns-universal" >> $GITHUB_OUTPUT
                echo "copy_spectra=true" >> $GITHUB_OUTPUT
                echo "copy_sdfxs=false" >> $GITHUB_OUTPUT
                ;;
              "generate-sdfxs-merkle")
                echo "type=sdtkns-universal" >> $GITHUB_OUTPUT
                echo "copy_spectra=false" >> $GITHUB_OUTPUT
                echo "copy_sdfxs=true" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "type=sdtkns-universal" >> $GITHUB_OUTPUT
                echo "copy_spectra=true" >> $GITHUB_OUTPUT
                echo "copy_sdfxs=true" >> $GITHUB_OUTPUT
                ;;
            esac
          else
            # workflow_dispatch - publish based on what was generated
            echo "type=sdtkns-universal" >> $GITHUB_OUTPUT
            case "${{ inputs.token }}" in
              "spectra")
                echo "copy_spectra=true" >> $GITHUB_OUTPUT
                echo "copy_sdfxs=false" >> $GITHUB_OUTPUT
                ;;
              "sdfxs")
                echo "copy_spectra=false" >> $GITHUB_OUTPUT
                echo "copy_sdfxs=true" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "copy_spectra=true" >> $GITHUB_OUTPUT
                echo "copy_sdfxs=true" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

      - name: Calculate current period
        id: period
        run: |
          WEEK=604800
          CURRENT_TIMESTAMP=$(date +%s)
          CURRENT_PERIOD=$(( CURRENT_TIMESTAMP / WEEK * WEEK ))
          echo "current=$CURRENT_PERIOD" >> $GITHUB_OUTPUT

      # ===== sdTokens (legacy) =====
      - name: Compute SDPENDLE Delegators APR
        if: steps.determine-type.outputs.type == 'sdtkns'
        run: |
          echo "Computing SDPENDLE delegators APR..."
          pnpm tsx script/helpers/computeSdPendleDelegatorsAPR.ts
        env:
          EXPLORER_KEY: ${{ secrets.ETHERSCAN_TOKEN }}
          WEB3_ALCHEMY_API_KEY: ${{ secrets.WEB3_ALCHEMY_API_KEY }}
        continue-on-error: true

      - name: Copy sdTokens merkle (legacy)
        if: steps.determine-type.outputs.type == 'sdtkns'
        run: |
          PERIOD=${{ steps.period.outputs.current }}
          
          # Copy legacy merkle files (backward compatibility)
          cp "bounties-reports/${PERIOD}/merkle.json" "bounties-reports/latest/merkle.json"
          cp "bounties-reports/${PERIOD}/delegationsAPRs.json" "bounties-reports/latest/delegationsAPRs.json"
          
          # Create sdTkns directory if needed
          mkdir -p "bounties-reports/latest/sdTkns"
          
          # Copy sdTkns merkle files
          if [ -d "bounties-reports/${PERIOD}/sdTkns" ]; then
            for file in bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_*.json; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                cp "$file" "bounties-reports/latest/sdTkns/${filename}"
                echo "Copied ${filename} to latest/sdTkns/"
              fi
            done
          fi

      # ===== sdTokens Universal (Spectra/sdFXS) =====
      - name: Copy universal merkle files
        if: steps.determine-type.outputs.type == 'sdtkns-universal'
        run: |
          PERIOD=${{ steps.period.outputs.current }}
          mkdir -p "bounties-reports/latest"
          
          # Copy Spectra merkle (Base chain 8453)
          if [ "${{ steps.determine-type.outputs.copy_spectra }}" = "true" ]; then
            if [ -f "bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_8453.json" ]; then
              echo "Copying Spectra merkle..."
              cp "bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_8453.json" "bounties-reports/latest/spectra_merkle.json"
            else
              echo "Spectra merkle not found for period ${PERIOD}, skipping..."
            fi
          fi
          
          # Copy sdFXS merkle (Fraxtal chain 252)
          if [ "${{ steps.determine-type.outputs.copy_sdfxs }}" = "true" ]; then
            if [ -f "bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_252.json" ]; then
              echo "Copying sdFXS merkle..."
              cp "bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_252.json" "bounties-reports/latest/sdfxs_merkle.json"
            else
              echo "sdFXS merkle not found for period ${PERIOD}, skipping..."
            fi
          fi
          
          # Merge period APRs with existing latest (preserves uncomputed protocols)
          if [ -f "bounties-reports/${PERIOD}/delegationsAPRs.json" ]; then
            if [ -f "bounties-reports/latest/delegationsAPRs.json" ]; then
              # Merge: latest values first, period values override
              jq -s '.[0] * .[1]' \
                bounties-reports/latest/delegationsAPRs.json \
                bounties-reports/${PERIOD}/delegationsAPRs.json \
                > bounties-reports/latest/delegationsAPRs.json.tmp
              mv bounties-reports/latest/delegationsAPRs.json.tmp bounties-reports/latest/delegationsAPRs.json
            else
              cp "bounties-reports/${PERIOD}/delegationsAPRs.json" "bounties-reports/latest/delegationsAPRs.json"
            fi
          fi

      - name: Determine commit message
        id: commit-msg
        run: |
          TYPE="${{ steps.determine-type.outputs.type }}"
          case "$TYPE" in
            "sdtkns")
              echo "message=chore: Update SDTokens merkle to latest" >> $GITHUB_OUTPUT
              ;;
            "sdtkns-universal")
              echo "message=chore: Update SD token merkles to latest" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Rebase on latest main before auto-commit
        run: git pull --rebase --autostash origin main

      - uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: ${{ steps.commit-msg.outputs.message }}
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          file_pattern: bounties-reports/latest/* delegationsAPRs.json

      - name: Send error notification to Telegram
        if: failure()
        uses: appleboy/telegram-action@v1.0.1
        with:
          to: -1002354704686
          token: ${{ secrets.TG_API_KEY_BOT_ERROR }}
          format: html
          message: |
            ‚ùå <b>Workflow failed</b>
            ‚Ä¢ <b>Workflow:</b> ${{ github.workflow }}
            ‚Ä¢ <b>Job:</b> publish-merkles
            ‚Ä¢ <b>Type:</b> ${{ steps.determine-type.outputs.type }}
            ‚Ä¢ <b>Trigger:</b> ${{ github.event_name }}
            ‚Ä¢ <b>Status:</b> ${{ job.status }}
            üìã <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View workflow logs</a>
