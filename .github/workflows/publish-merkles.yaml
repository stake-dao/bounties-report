name: "Publish Merkles"

on:
  workflow_dispatch:
    inputs:
      type:
        description: "Type of merkle to publish"
        required: true
        type: choice
        options:
          - vlcvx-delegators
          - vlcvx-non-delegators
          - vlaura
          - sdtkns
          - sdtkns-universal
  repository_dispatch:
    types: 
      - copy-vlcvx-merkle
      - copy-vlaura-merkle
      - copy-sdtkns-merkle
      - copy-spectra-merkle
      - copy-sdfxs-merkle
      - copy-all-sd-merkles

jobs:
  publish-merkles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Configure git and pull latest changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git pull origin main --rebase

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.5.1"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Determine publish type
        id: determine-type
        run: |
          # Priority: workflow_dispatch input > repository_dispatch mapping
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            case "${{ github.event.action }}" in
              "copy-vlcvx-merkle")
                # Check client_payload for delegators/non-delegators
                VLCVX_TYPE="${{ github.event.client_payload.type }}"
                if [ "$VLCVX_TYPE" = "delegators" ]; then
                  echo "type=vlcvx-delegators" >> $GITHUB_OUTPUT
                else
                  echo "type=vlcvx-non-delegators" >> $GITHUB_OUTPUT
                fi
                ;;
              "copy-vlaura-merkle")
                echo "type=vlaura" >> $GITHUB_OUTPUT
                ;;
              "copy-sdtkns-merkle")
                echo "type=sdtkns" >> $GITHUB_OUTPUT
                ;;
              "copy-spectra-merkle"|"copy-sdfxs-merkle"|"copy-all-sd-merkles")
                echo "type=sdtkns-universal" >> $GITHUB_OUTPUT
                # Pass through the specific action for universal handler
                echo "universal_action=${{ github.event.action }}" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "type=sdtkns" >> $GITHUB_OUTPUT
                ;;
            esac
          else
            echo "type=sdtkns" >> $GITHUB_OUTPUT
          fi

      - name: Calculate current period
        id: period
        run: |
          WEEK=604800
          CURRENT_TIMESTAMP=$(date +%s)
          CURRENT_PERIOD=$(( CURRENT_TIMESTAMP / WEEK * WEEK ))
          echo "current=$CURRENT_PERIOD" >> $GITHUB_OUTPUT

      # ===== vlCVX Non-Delegators =====
      - name: Copy vlCVX non-delegators merkle
        if: steps.determine-type.outputs.type == 'vlcvx-non-delegators'
        run: |
          PERIOD=${{ steps.period.outputs.current }}
          
          # Copy main merkle file
          cp "bounties-reports/${PERIOD}/vlCVX/vlcvx_merkle.json" "bounties-reports/latest/vlCVX/vlcvx_merkle.json"
          
          # Find and copy chain-specific merkle files
          for file in bounties-reports/${PERIOD}/vlCVX/vlcvx_merkle_*.json; do
            if [ -f "$file" ]; then
              CHAIN_ID=$(echo "$file" | sed 's/.*_\([0-9]*\)\.json/\1/')
              cp "$file" "bounties-reports/latest/vlCVX/vlcvx_merkle_${CHAIN_ID}.json"
            fi
          done

      # ===== vlAURA =====
      - name: Copy vlAURA merkle
        if: steps.determine-type.outputs.type == 'vlaura'
        run: |
          PERIOD=${{ steps.period.outputs.current }}
          mkdir -p "bounties-reports/latest/vlAURA"
          
          # Copy main merkle file
          if [ -f "bounties-reports/${PERIOD}/vlAURA/vlaura_merkle.json" ]; then
            cp "bounties-reports/${PERIOD}/vlAURA/vlaura_merkle.json" "bounties-reports/latest/vlAURA/vlaura_merkle.json"
          fi
          
          # Find and copy chain-specific merkle files
          for file in bounties-reports/${PERIOD}/vlAURA/vlaura_merkle_*.json; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              cp "$file" "bounties-reports/latest/vlAURA/${filename}"
              echo "Copied ${filename} to latest/vlAURA/"
            fi
          done

      # ===== vlCVX Delegators =====
      - name: Copy vlCVX delegators merkle
        if: steps.determine-type.outputs.type == 'vlcvx-delegators'
        run: |
          PERIOD=${{ steps.period.outputs.current }}
          cp "bounties-reports/${PERIOD}/vlCVX/merkle_data_delegators.json" "bounties-reports/latest/vlCVX/vlcvx_merkle_delegators.json"

      - name: Compute vlCVX delegation APR
        if: steps.determine-type.outputs.type == 'vlcvx-delegators'
        run: |
          PERIOD=${{ steps.period.outputs.current }}
          
          # Run APR computation
          pnpm tsx script/helpers/computevlCVXDelegatorsAPR.ts
          
          # Copy APRs.json to latest
          if [ -f "bounties-reports/${PERIOD}/vlCVX/APRs.json" ]; then
            cp "bounties-reports/${PERIOD}/vlCVX/APRs.json" "bounties-reports/latest/vlCVX/APRs.json"
          fi
        env:
          EXPLORER_KEY: ${{ secrets.ETHERSCAN_TOKEN }}
          WEB3_ALCHEMY_API_KEY: ${{ secrets.WEB3_ALCHEMY_API_KEY }}

      # ===== sdTokens =====
      - name: Compute SDPENDLE Delegators APR
        if: steps.determine-type.outputs.type == 'sdtkns'
        run: |
          echo "Computing SDPENDLE delegators APR..."
          npx ts-node script/helpers/computeSdPendleDelegatorsAPR.ts
        env:
          EXPLORER_KEY: ${{ secrets.ETHERSCAN_TOKEN }}
          WEB3_ALCHEMY_API_KEY: ${{ secrets.WEB3_ALCHEMY_API_KEY }}
        continue-on-error: true

      - name: Copy sdTokens merkle
        if: steps.determine-type.outputs.type == 'sdtkns'
        run: |
          PERIOD=${{ steps.period.outputs.current }}
          
          # Copy legacy merkle files (backward compatibility)
          cp "bounties-reports/${PERIOD}/merkle.json" "bounties-reports/latest/merkle.json"
          cp "bounties-reports/${PERIOD}/delegationsAPRs.json" "bounties-reports/latest/delegationsAPRs.json"
          
          # Create sdTkns directory if needed
          mkdir -p "bounties-reports/latest/sdTkns"
          
          # Copy sdTkns merkle files
          if [ -d "bounties-reports/${PERIOD}/sdTkns" ]; then
            for file in bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_*.json; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                cp "$file" "bounties-reports/latest/sdTkns/${filename}"
                echo "Copied ${filename} to latest/sdTkns/"
              fi
            done
          fi

      # ===== sdTokens Universal (Spectra/sdFXS) =====
      - name: Determine universal merkle targets
        if: steps.determine-type.outputs.type == 'sdtkns-universal'
        id: universal
        run: |
          ACTION="${{ steps.determine-type.outputs.universal_action }}"
          if [ "$ACTION" = "copy-spectra-merkle" ]; then
            echo "copy_spectra=true" >> $GITHUB_OUTPUT
            echo "copy_sdfxs=false" >> $GITHUB_OUTPUT
          elif [ "$ACTION" = "copy-sdfxs-merkle" ]; then
            echo "copy_spectra=false" >> $GITHUB_OUTPUT
            echo "copy_sdfxs=true" >> $GITHUB_OUTPUT
          else
            # copy-all-sd-merkles or workflow_dispatch
            echo "copy_spectra=true" >> $GITHUB_OUTPUT
            echo "copy_sdfxs=true" >> $GITHUB_OUTPUT
          fi

      - name: Copy universal merkle files
        if: steps.determine-type.outputs.type == 'sdtkns-universal'
        run: |
          PERIOD=${{ steps.period.outputs.current }}
          mkdir -p "bounties-reports/latest"
          
          # Copy Spectra merkle (Base chain 8453)
          if [ "${{ steps.universal.outputs.copy_spectra }}" = "true" ]; then
            if [ -f "bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_8453.json" ]; then
              echo "Copying Spectra merkle..."
              cp "bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_8453.json" "bounties-reports/latest/spectra_merkle.json"
            else
              echo "Spectra merkle not found for period ${PERIOD}, skipping..."
            fi
          fi
          
          # Copy sdFXS merkle (Fraxtal chain 252)
          if [ "${{ steps.universal.outputs.copy_sdfxs }}" = "true" ]; then
            if [ -f "bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_252.json" ]; then
              echo "Copying sdFXS merkle..."
              cp "bounties-reports/${PERIOD}/sdTkns/sdtkns_merkle_252.json" "bounties-reports/latest/sdfxs_merkle.json"
            else
              echo "sdFXS merkle not found for period ${PERIOD}, skipping..."
            fi
          fi
          
          # Copy delegationsAPRs.json
          if [ -f "bounties-reports/${PERIOD}/delegationsAPRs.json" ]; then
            cp "bounties-reports/${PERIOD}/delegationsAPRs.json" "bounties-reports/delegationsAPRs.json"
          fi

      - name: Determine commit message
        id: commit-msg
        run: |
          TYPE="${{ steps.determine-type.outputs.type }}"
          case "$TYPE" in
            "vlcvx-delegators")
              echo "message=chore: Update vlCVX delegators merkle to latest" >> $GITHUB_OUTPUT
              ;;
            "vlcvx-non-delegators")
              echo "message=chore: Update vlCVX merkle to latest" >> $GITHUB_OUTPUT
              ;;
            "vlaura")
              echo "message=chore: Update vlAURA merkle to latest" >> $GITHUB_OUTPUT
              ;;
            "sdtkns")
              echo "message=chore: Update SDTokens merkle to latest" >> $GITHUB_OUTPUT
              ;;
            "sdtkns-universal")
              echo "message=chore: Update SD token merkles to latest" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Rebase on latest main before auto-commit
        run: git pull --rebase --autostash origin main

      - uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: ${{ steps.commit-msg.outputs.message }}
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          file_pattern: bounties-reports/latest/* delegationsAPRs.json

      - name: Send error notification to Telegram
        if: failure()
        uses: appleboy/telegram-action@v1.0.1
        with:
          to: -1002354704686
          token: ${{ secrets.TG_API_KEY_BOT_ERROR }}
          format: html
          message: |
            <b>Workflow failed</b>
            <b>Workflow:</b> ${{ github.workflow }}
            <b>Job:</b> publish-merkles
            <b>Type:</b> ${{ steps.determine-type.outputs.type }}
            <b>Trigger:</b> ${{ github.event_name }}
            <b>Status:</b> ${{ job.status }}
            <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View workflow logs</a>
