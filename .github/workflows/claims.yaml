name: "Claims"

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to claim from'
        required: true
        type: choice
        options:
          - votemarket
          - votemarket-v2
          - warden
          - hiddenhand
          - spectra
          - convex-v2
          - votium
      dispatch_id:
        description: 'Unique dispatch ID for tracking'
        required: false
        type: string
        default: ''
      past_week:
        description: 'Number of weeks in the past (0 for current)'
        required: false
        type: string
        default: '0'

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          python: 'true'

      - name: Generate claims
        run: |
          case "${{ inputs.platform }}" in
            votemarket)    make -f automation/weekly-bounties.mk run-votemarket PAST_WEEK=${{ inputs.past_week }} ;;
            votemarket-v2) make -f automation/weekly-bounties.mk run-votemarket-v2 PAST_WEEK=${{ inputs.past_week }} ;;
            warden)        make -f automation/weekly-bounties.mk run-warden PAST_WEEK=${{ inputs.past_week }} ;;
            hiddenhand)    make -f automation/weekly-bounties.mk run-hiddenhand PAST_WEEK=${{ inputs.past_week }} ;;
            spectra)       make -f automation/weekly-bounties.mk run-spectra PAST_WEEK=${{ inputs.past_week }} ;;
            convex-v2)     make -f automation/weekly-bounties.mk run-convex-v2 PAST_WEEK=${{ inputs.past_week }} ;;
            votium)        pnpm tsx script/vlCVX/claims/generateConvexVotium.ts ${{ inputs.past_week }} ;;
          esac
        env:
          EXPLORER_KEY: ${{ secrets.ETHERSCAN_TOKEN }}
          WEB3_ALCHEMY_API_KEY: ${{ secrets.WEB3_ALCHEMY_API_KEY }}
          TELEGRAM_VERIF_API_KEY: ${{ secrets.TELEGRAM_VERIF_API_KEY }}
          TELEGRAM_VERIF_CHAT_ID: ${{ secrets.TELEGRAM_VERIF_CHAT_ID }}

      - name: Run delegators indexer (votium only)
        if: inputs.platform == 'votium'
        run: make -f automation/indexer.mk get-delegators
        env:
          EXPLORER_KEY: ${{ secrets.ETHERSCAN_TOKEN }}
          WEB3_ALCHEMY_API_KEY: ${{ secrets.WEB3_ALCHEMY_API_KEY }}

      - name: Commit and push
        uses: ./.github/actions/commit-and-push
        with:
          message: "chore: ${{ inputs.platform }} claims [${{ inputs.dispatch_id }}]"

      - name: Notify on failure
        if: failure()
        uses: ./.github/actions/notify-failure
        with:
          workflow_name: "Claims: ${{ inputs.platform }}"
          dispatch_id: ${{ inputs.dispatch_id }}
          telegram_token: ${{ secrets.TG_API_KEY_BOT_ERROR }}
