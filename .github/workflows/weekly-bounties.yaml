name: "[Votemarket] Weekly Bounties"

on:
  workflow_call:
    inputs:
      bountyType:
        type: string
        required: true
      pastWeek:
        type: string
        required: false
        default: '0'
      chain:
        type: string
        required: false
        default: 'mainnet'
  workflow_dispatch:
    inputs:
      bountyType:
        description: "Type of bounty to process"
        required: true
        type: choice
        options:
          - votemarket
          - votemarket-v2
          - warden
          - hiddenhand
          - convex
          - convex-v2
      pastWeek:
        description: "Number of weeks in the past (0 for current week)"
        required: true
        default: "0"
      chain:
        description: "Chain to check for claimed bounties"
        required: true
        type: choice
        options:
          - mainnet
          - bsc
  schedule:
    - cron: "0 19 * * 4" # Every Thursday at 19:00 UTC

jobs:
  process-bounties:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10.13"

      - name: Run generate bounties script
        if: github.event_name != 'schedule'
        run: |
          make -f automation/weekly-bounties.mk run-${{ inputs.bountyType || github.event.inputs.bountyType }} PAST_WEEK=${{ inputs.pastWeek || github.event.inputs.pastWeek }} CHAIN=${{ inputs.chain || github.event.inputs.chain }}
        env:
          EXPLORER_KEY: ${{ secrets.ETHERSCAN_TOKEN}}

      - name: Run generate bounties script (all on schedule)
        if: github.event_name == 'schedule'
        run: |
          # Calculate current period
          WEEK=604800
          CURRENT_TIMESTAMP=$(date +%s)
          CURRENT_PERIOD=$(( CURRENT_TIMESTAMP / WEEK * WEEK ))
          BASE_DIR="weekly-bounties/$CURRENT_PERIOD"
          
          # Check and run each protocol if needed
          if [ ! -f "$BASE_DIR/votemarket/claimed_bounties.json" ]; then
            make -f automation/weekly-bounties.mk run-votemarket PAST_WEEK=0 CHAIN=mainnet
          fi
          
          if [ ! -f "$BASE_DIR/votemarket-v2/claimed_bounties.json" ]; then
            make -f automation/weekly-bounties.mk run-votemarket-v2 PAST_WEEK=0 CHAIN=mainnet
          fi
          
          if [ ! -f "$BASE_DIR/warden/claimed_bounties.json" ]; then
            make -f automation/weekly-bounties.mk run-warden PAST_WEEK=0 CHAIN=mainnet
          fi
          
          if [ ! -f "$BASE_DIR/hiddenhand/claimed_bounties.json" ]; then
            make -f automation/weekly-bounties.mk run-hiddenhand PAST_WEEK=0 CHAIN=mainnet
          fi
          
          if [ ! -f "$BASE_DIR/votemarket/claimed_bounties_convex.json" ]; then
            make -f automation/weekly-bounties.mk run-convex PAST_WEEK=0 CHAIN=mainnet
          fi
          
          if [ ! -f "$BASE_DIR/votemarket-v2/claimed_bounties_convex.json" ]; then
            make -f automation/weekly-bounties.mk run-convex-v2 PAST_WEEK=0 CHAIN=mainnet
          fi
        env:
          EXPLORER_KEY: ${{ secrets.ETHERSCAN_TOKEN}}

      - name: Commit and push changes
        run: |
          BOUNTY_TYPE="${{ inputs.bountyType || github.event.inputs.bountyType }}"
          CHAIN="${{ inputs.chain || github.event.inputs.chain }}"
          make -f automation/weekly-bounties.mk commit-and-push COMMIT_MSG="Update ${BOUNTY_TYPE} bounties for ${CHAIN}"